name: Publish Static Dashboard (gh-pages)

on:
  push:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: gh-pages
  cancel-in-progress: true

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Run Glance in Docker (pin to match the binary in this repo: v0.8.4).
      - name: Start Glance
        id: glance
        run: |
          cid="$(docker run -d --rm \
            -p 8080:8080 \
            -v "$GITHUB_WORKSPACE:/work" \
            -w /work \
            glanceapp/glance:v0.8.4 \
            --config ./config/glance.yml)"
          echo "cid=$cid" >> "$GITHUB_OUTPUT"

      # Export a static snapshot by crawling Glance's rendered page-content endpoint.
      - name: Export Static Site
        env:
          GLANCE_URL: http://127.0.0.1:8080
          OUT_DIR: dist
          # GitHub project pages live under /<repo-name>/.
          BASE_PATH: /${{ github.event.repository.name }}
        run: |
          python3 scripts/export_static.py

      - name: Stop Glance
        if: always()
        run: |
          docker stop "${{ steps.glance.outputs.cid }}" || true

      - name: Deploy To gh-pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: gh-pages
          folder: dist
          clean: true
          single-commit: true

